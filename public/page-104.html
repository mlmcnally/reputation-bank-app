<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Avenir','Nunito Sans',sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:2rem;
      color:#000;
    }
    h2{color:#084a58;text-align:center;margin-top:0;}
    .container{
      display:flex;
      gap:1rem;
      align-items:flex-start;
      max-width:1400px;
      margin:0 auto;
    }
    .left{
      flex:0 0 45%;
      max-width:45%;
    }
    .left img{
      width:100%;
      height:auto;
      border:1px solid #ccc;
      border-radius:8px;
      display:block;
    }
    .button-bar{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:1rem;
    }
    .button-bar button{
      background-color:#084a58;
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:4px;
      cursor:pointer;
      font-size:0.95rem;
      box-shadow:2px 2px 4px rgba(0,0,0,0.3);
    }
    .button-bar button:hover{opacity:0.9;}

    .right{
      flex:1 1 55%;
      max-width:55%;
    }
    .instructions{
      background:#fff;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
      padding:1rem 1.5rem;
      margin-bottom:1rem;
      line-height:1.5;
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    th,td{
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
    }
    th{background:#e2e8f0;}
    tfoot td{background:#e0f2fe;font-weight:bold;}

    .footer-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:1rem;
    }
    .footer-buttons button{
      flex:1;
      min-width:160px;
      background-color:#084a58;
      color:#fff;
      border:none;
      padding:10px 16px;
      border-radius:4px;
      cursor:pointer;
      box-shadow:2px 2px 4px rgba(0,0,0,0.3);
      font-size:0.95rem;
    }
    .footer-buttons button:hover{opacity:0.9;}

    #statusMsg{
      margin-top:1rem;
      text-align:center;
      font-weight:600;
      color:#084a58;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <img src="/page-104.jpg" alt="Exercise 15 Page 104"/>
      <div class="button-bar">
        <button onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
        <button onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
        <button onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
        <button onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
      </div>
    </div>

    <div class="right">
      <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
      <p class="instructions">
        This exercise brings your entire reputation bank together ‚Äî all deposits and withdrawals.
        Use the buttons to populate data from previous exercises and then save your completed
        statement. Reflect on how to strengthen deposits and mitigate risks.
      </p>

      <table>
        <thead>
          <tr>
            <th>Name/Description</th>
            <th>Credibility Cash Deposits</th>
            <th>Credibility Debt Withdrawals</th>
            <th>Credibility Gold Deposits</th>
            <th>Credibility Cryptocurrency Withdrawals</th>
          </tr>
        </thead>
        <tbody id="bankTableBody"></tbody>
        <tfoot>
          <tr>
            <td>Subtotals</td>
            <td id="subtotalCash"></td>
            <td id="subtotalDebt"></td>
            <td id="subtotalGold"></td>
            <td id="subtotalCrypto"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align:right;">
              Reputation Bank Balance: <span id="bankBalance"></span>
            </td>
          </tr>
        </tfoot>
      </table>

      <div class="footer-buttons">
        <button onclick="window.location.href='/#page/103'">‚¨Ö Back One Page</button>
        <button onclick="saveData()">üíæ Save</button>
        <button onclick="saveAndNext()">‚û° Save & Go to Page 105</button>
        <button onclick="window.print()">üñ®Ô∏è Print</button>
        <button onclick="goToTOC()">Go to Table of Contents</button>
      </div>
      <div id="statusMsg"></div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    async function getCurrentUser(){
      const { data:{ session } } = await supabase.auth.getSession();
      if(session?.user) return session.user;
      const { data:{ user } } = await supabase.auth.getUser();
      return user??null;
    }

    // Build 12 editable rows
    document.addEventListener("DOMContentLoaded",()=>{
      const tbody=document.getElementById('bankTableBody');
      for(let i=0;i<12;i++){
        const row=document.createElement('tr');
        for(let j=0;j<5;j++){
          const td=document.createElement('td');
          td.contentEditable=true;
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
    });

    const rowMap={
      cash:[{row:0,table:'exercise10_page82'},{row:1,table:'exercise10_page83'},{row:2,table:'exercise10_page84'}],
      gold:[{row:3,table:'exercise11_page87'},{row:4,table:'exercise11_page88'},{row:5,table:'exercise11_page89'}],
      debt:[{row:6,table:'exercise13_page94'},{row:7,table:'exercise13_page95'},{row:8,table:'exercise13_page96'}],
      crypto:[{row:9,table:'exercise14_page99'},{row:10,table:'exercise14_page100'},{row:11,table:'exercise14_page101'}]
    };
    const columnMap={
      cash:'annual_deposit',
      gold:'credibility_gold_deposit',
      debt:'annual_deposit',
      crypto:'crypto_withdrawal'
    };

    async function insertFromExercise(type){
      const user=await getCurrentUser();
      if(!user) return alert("User not logged in");
      const rows=document.querySelectorAll('#bankTableBody tr');
      const targets=rowMap[type];
      const column=columnMap[type];
      for(const target of targets){
        const { data,error } = await supabase
          .from(target.table)
          .select(`interaction_description, ${column}`)
          .eq('user_id',user.id)
          .maybeSingle();
        if(!error && data){
          rows[target.row].children[0].textContent=data.interaction_description||'';
          const colIndex={cash:1,debt:2,gold:3,crypto:4}[type];
          rows[target.row].children[colIndex].textContent=data[column]??'';
        }
      }
      calculateSubtotals();
    }

    function calculateSubtotals(){
      let cash=0,debt=0,gold=0,crypto=0;
      document.querySelectorAll('#bankTableBody tr').forEach(row=>{
        const c=row.children;
        cash+=parseFloat(c[1].textContent)||0;
        debt+=parseFloat(c[2].textContent)||0;
        gold+=parseFloat(c[3].textContent)||0;
        crypto+=parseFloat(c[4].textContent)||0;
      });
      document.getElementById('subtotalCash').textContent=cash.toFixed(2);
      document.getElementById('subtotalDebt').textContent=debt.toFixed(2);
      document.getElementById('subtotalGold').textContent=gold.toFixed(2);
      document.getElementById('subtotalCrypto').textContent=crypto.toFixed(2);
      document.getElementById('bankBalance').textContent=(cash+gold+debt+crypto).toFixed(2);
    }

    async function saveData(){
      const status=document.getElementById('statusMsg');
      status.textContent='';
      const user=await getCurrentUser();
      if(!user){status.textContent='‚ùå User not authenticated';status.style.color='red';return;}

      const updates=[];
      const rows=document.querySelectorAll('#bankTableBody tr');
      rows.forEach((row,i)=>{
        const c=row.children;
        updates.push({
          user_id:user.id,
          row_number:i+1,
          interaction_description:c[0].textContent.trim(),
          credibility_cash_deposit:parseFloat(c[1].textContent)||0,
          credibility_debt_withdrawal:parseFloat(c[2].textContent)||0,
          credibility_gold_deposit:parseFloat(c[3].textContent)||0,
          credibility_crypto_withdrawal:parseFloat(c[4].textContent)||0
        });
      });

      for(const r of updates){
        await supabase.from('exercise15_page104').upsert(r,{onConflict:['user_id','row_number']});
      }

      status.textContent='‚úÖ Saved successfully!';
      status.style.color='#084a58';
      calculateSubtotals();
    }

    async function saveAndNext(){
      await saveData();
      window.location.href='/#page/105';
    }
    function goToTOC(){window.location.href='/page-3.html';}
  </script>
</body>
</html>
