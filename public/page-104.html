<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Avenir','Nunito Sans',sans-serif;
      background:#f3f4f6;
      margin:0;
      padding:2rem;
      color:#000;
    }
    h2{color:#084a58;text-align:center;margin-top:0;}

    .container{
      display:flex;
      gap:1rem;
      align-items:flex-start;
      max-width:1400px;
      margin:0 auto;
    }
    .left{
      flex:0 0 45%;
      max-width:45%;
    }
    .left img{
      width:100%;
      height:auto;
      border:1px solid #ccc;
      border-radius:8px;
      display:block;
    }

    .button-bar{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:1rem;
    }
    .button-bar button{
      background-color:#084a58;
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:4px;
      cursor:pointer;
      font-size:0.95rem;
      box-shadow:2px 2px 4px rgba(0,0,0,0.3);
      font-family: inherit;
    }
    .button-bar button:hover{opacity:0.9;}

    .right{
      flex:1 1 55%;
      max-width:55%;
    }
    .instructions{
      background:#fff;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
      padding:1rem 1.5rem;
      margin-bottom:1rem;
      line-height:1.5;
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    th,td{
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
      vertical-align: top;
      font-family: inherit;
    }
    th{background:#e2e8f0;}
    tfoot td{background:#e0f2fe;font-weight:bold;}

    .footer-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:1rem;
    }
    .footer-buttons button{
      flex:1;
      min-width:160px;
      background-color:#084a58;
      color:#fff;
      border:none;
      padding:10px 16px;
      border-radius:4px;
      cursor:pointer;
      box-shadow:2px 2px 4px rgba(0,0,0,0.3);
      font-size:0.95rem;
      font-family: inherit;
    }
    .footer-buttons button:hover{opacity:0.9;}

    #statusMsg{
      margin-top:1rem;
      text-align:center;
      font-weight:600;
      color:#084a58;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <img src="/page-104.jpg" alt="Exercise 15 Page 104"/>
      <div class="button-bar">
        <button type="button" onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
        <button type="button" onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
        <button type="button" onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
        <button type="button" onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
      </div>
    </div>

    <div class="right">
      <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
      <p class="instructions">
        This exercise brings your entire reputation bank together ‚Äî all deposits and withdrawals.
        Use the buttons to populate data from previous exercises and then save your completed
        statement. Reflect on how to strengthen deposits and mitigate risks.
      </p>

      <table>
        <thead>
          <tr>
            <th>Name/Description</th>
            <th>Credibility Cash Deposits</th>
            <th>Credibility Debt Withdrawals</th>
            <th>Credibility Gold Deposits</th>
            <th>Credibility Cryptocurrency Withdrawals</th>
          </tr>
        </thead>
        <tbody id="bankTableBody"></tbody>
        <tfoot>
          <tr>
            <td>Subtotals</td>
            <td id="subtotalCash"></td>
            <td id="subtotalDebt"></td>
            <td id="subtotalGold"></td>
            <td id="subtotalCrypto"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align:right;">
              Reputation Bank Balance: <span id="bankBalance"></span>
            </td>
          </tr>
        </tfoot>
      </table>

      <div class="footer-buttons">
        <button type="button" onclick="window.location.href='/#page/103'">‚¨Ö Back One Page</button>
        <button type="button" onclick="saveData()">üíæ Save</button>
        <button type="button" onclick="saveAndNext()">‚û° Save & Go to Page 105</button>
        <button type="button" onclick="window.print()">üñ®Ô∏è Print</button>
        <button type="button" onclick="goToTOC()">Go to Table of Contents</button>
      </div>

      <div id="statusMsg"></div>
    </div>
  </div>

  <script>
    // ‚úÖ Use same project + anon key
    const supabase = window.supabase.createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    function setStatus(message, color = "#084a58") {
      const el = document.getElementById("statusMsg");
      el.textContent = message;
      el.style.color = color;
    }

    async function getCurrentUser(){
      const { data:{ session } } = await supabase.auth.getSession();
      if (session?.user) return session.user;
      const { data:{ user } } = await supabase.auth.getUser();
      return user ?? null;
    }

    // Build 12 editable rows
    document.addEventListener("DOMContentLoaded", async () => {
      const tbody = document.getElementById('bankTableBody');
      tbody.innerHTML = "";

      for (let i = 0; i < 12; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 5; j++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.spellcheck = true;
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }

      // Recalc when user edits any cell
      tbody.addEventListener("input", () => calculateSubtotals());

      // Load saved statement if it exists (so Back/Forward shows data)
      await loadSavedStatement();

      // Initialize totals
      calculateSubtotals();
    });

    const rowMap = {
      cash:  [{row:0,table:'exercise10_page82'},{row:1,table:'exercise10_page83'},{row:2,table:'exercise10_page84'}],
      gold:  [{row:3,table:'exercise11_page87'},{row:4,table:'exercise11_page88'},{row:5,table:'exercise11_page89'}],
      debt:  [{row:6,table:'exercise13_page94'},{row:7,table:'exercise13_page95'},{row:8,table:'exercise13_page96'}],
      crypto:[{row:9,table:'exercise14_page99'},{row:10,table:'exercise14_page100'},{row:11,table:'exercise14_page101'}]
    };

    const columnMap = {
      cash:'annual_deposit',
      gold:'credibility_gold_deposit',
      debt:'annual_deposit',
      crypto:'crypto_withdrawal'
    };

    function parseNum(val) {
      const n = Number(String(val ?? "").replace(/[^0-9.-]/g, ""));
      return Number.isFinite(n) ? n : 0;
    }

    async function insertFromExercise(type){
      const user = await getCurrentUser();
      if(!user) { alert("User not logged in"); return; }

      const rows = document.querySelectorAll('#bankTableBody tr');
      const targets = rowMap[type];
      const column = columnMap[type];
      const colIndex = {cash:1,debt:2,gold:3,crypto:4}[type];

      setStatus(`Loading ${type}...`);

      for (const target of targets) {
        const { data, error } = await supabase
          .from(target.table)
          .select(`interaction_description, ${column}`)
          .eq('user_id', user.id)
          .maybeSingle();

        if (error) {
          setStatus(`‚ùå Error loading ${type} from ${target.table}:\n${error.message}`, "red");
          continue;
        }

        if (!data) continue;

        rows[target.row].children[0].textContent = data.interaction_description || '';
        rows[target.row].children[colIndex].textContent = (data[column] ?? '').toString();
      }

      calculateSubtotals();
      setStatus(`‚úÖ Inserted ${type}.`);
    }

    function calculateSubtotals(){
      let cash=0,debt=0,gold=0,crypto=0;

      document.querySelectorAll('#bankTableBody tr').forEach(row=>{
        const c=row.children;
        cash += parseNum(c[1].textContent);
        debt += parseNum(c[2].textContent);
        gold += parseNum(c[3].textContent);
        crypto += parseNum(c[4].textContent);
      });

      document.getElementById('subtotalCash').textContent = cash.toFixed(2);
      document.getElementById('subtotalDebt').textContent = debt.toFixed(2);
      document.getElementById('subtotalGold').textContent = gold.toFixed(2);
      document.getElementById('subtotalCrypto').textContent = crypto.toFixed(2);

      // debt + crypto are negative already
      document.getElementById('bankBalance').textContent = (cash + gold + debt + crypto).toFixed(2);
    }

    async function loadSavedStatement(){
      const user = await getCurrentUser();
      if (!user) return;

      // IMPORTANT: these columns must exist in exercise15_page104
      const { data, error } = await supabase
        .from('exercise15_page104')
        .select('row_index,interaction_description,credibility_cash_deposit,credibility_debt_withdrawal,credibility_gold_deposit,credibility_crypto_withdrawal')
        .eq('user_id', user.id)
        .order('row_index', { ascending: true });

      if (error) {
        // Don‚Äôt block the page ‚Äî just inform quietly
        setStatus("‚ÑπÔ∏è Could not load saved statement:\n" + error.message, "#6b7280");
        return;
      }

      if (!data || data.length === 0) return;

      const rows = document.querySelectorAll('#bankTableBody tr');
      data.forEach(r => {
        const idx = (r.row_index ?? 0) - 1;
        if (idx < 0 || idx >= rows.length) return;
        const c = rows[idx].children;
        c[0].textContent = r.interaction_description ?? "";
        c[1].textContent = (r.credibility_cash_deposit ?? "").toString();
        c[2].textContent = (r.credibility_debt_withdrawal ?? "").toString();
        c[3].textContent = (r.credibility_gold_deposit ?? "").toString();
        c[4].textContent = (r.credibility_crypto_withdrawal ?? "").toString();
      });

      calculateSubtotals();
      setStatus("‚úÖ Loaded saved statement.");
    }

    async function saveData(){
      const user = await getCurrentUser();
      if(!user){
        setStatus('‚ùå User not authenticated', 'red');
        return;
      }

      setStatus("Saving...");

      const rows = document.querySelectorAll('#bankTableBody tr');
      const updates = [];

      rows.forEach((row,i)=>{
        const c=row.children;
        updates.push({
          user_id: user.id,

          // ‚úÖ FIX: your table requires row_index (NOT NULL)
          row_index: i + 1,

          // ‚úÖ FIX: must match your DB column name
          interaction_description: (c[0].textContent || "").trim(),

          credibility_cash_deposit: parseNum(c[1].textContent),
          credibility_debt_withdrawal: parseNum(c[2].textContent),
          credibility_gold_deposit: parseNum(c[3].textContent),
          credibility_crypto_withdrawal: parseNum(c[4].textContent)
        });
      });

      // ‚úÖ Save all rows at once
      const { error } = await supabase
        .from('exercise15_page104')
        .upsert(updates, { onConflict: 'user_id,row_index' });

      if (error) {
        setStatus('‚ùå Error saving statement:\n' + error.message, 'red');
        return;
      }

      calculateSubtotals();
      setStatus('‚úÖ Saved successfully!');
    }

    async function saveAndNext(){
      await saveData();
      window.location.href='/#page/105';
    }

    function goToTOC(){window.location.href='/page-3.html';}
  </script>
</body>
</html>
