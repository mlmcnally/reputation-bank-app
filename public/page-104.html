<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    .left {
      flex: 1;
      padding-right: 2rem;
    }
    .right {
      flex: 2;
    }
    .button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #e2e8f0;
    }
    tfoot td {
      background: #e0f2fe;
      font-weight: bold;
    }
    .footer-buttons {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <img src="/page-104.jpg" alt="Exercise 15 Page 104" style="width: 100%; border: 1px solid #ccc;" />
    </div>
    <div class="right">
      <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
      <p>Refer to Exercises 10, 11, 13 and 14 (credibility cash, gold, debt, and cryptocurrency). Credibility cash and gold should be positive numbers, while debt and cryptocurrency should be negative. Subtotals and the Reputation Bank Balance are calculated automatically.</p>

      <div class="button-bar">
        <button onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
        <button onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
        <button onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
        <button onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name/Description</th>
            <th>Credibility Cash Deposits</th>
            <th>Credibility Debt Withdrawals</th>
            <th>Credibility Gold Deposits</th>
            <th>Credibility Cryptocurrency Withdrawals</th>
          </tr>
        </thead>
        <tbody id="bankTableBody">
          <!-- Pre-render 12 editable rows -->
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
          <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td>Subtotals</td>
            <td id="subtotalCash"></td>
            <td id="subtotalDebt"></td>
            <td id="subtotalGold"></td>
            <td id="subtotalCrypto"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align: right;">Reputation Bank Balance: <span id="bankBalance"></span></td>
          </tr>
        </tfoot>
      </table>
      <div class="footer-buttons">
        <button onclick="window.location.href='/#page/103'">‚¨Ö Back One Page</button>
        <button onclick="window.print()">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    const exerciseMappings = {
      cash: [
        { table: 'exercise10_page82', row: 0, column: 1 },
        { table: 'exercise10_page83', row: 1, column: 1 },
        { table: 'exercise10_page84', row: 2, column: 1 }
      ],
      gold: [
        { table: 'exercise11_page87', row: 3, column: 3 },
        { table: 'exercise11_page88', row: 4, column: 3 },
        { table: 'exercise11_page89', row: 5, column: 3 }
      ],
      debt: [
        { table: 'exercise13_page94', row: 6, column: 2 },
        { table: 'exercise13_page95', row: 7, column: 2 },
        { table: 'exercise13_page96', row: 8, column: 2 }
      ],
      crypto: [
        { table: 'exercise14_page99', row: 9, column: 4 },
        { table: 'exercise14_page100', row: 10, column: 4 },
        { table: 'exercise14_page101', row: 11, column: 4 }
      ]
    };

    const columnNameMap = {
      cash: 'annual_deposit',
      gold: 'credibility_gold_deposit',
      debt: 'annual_deposit',
      crypto: 'crypto_withdrawal'
    };

    async function insertFromExercise(type) {
      const { data: userData, error: authError } = await supabaseClient.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) return alert("User not logged in");

      const tbody = document.getElementById('bankTableBody');
      const rows = tbody.querySelectorAll('tr');

      for (let mapping of exerciseMappings[type]) {
        const { table, row, column } = mapping;
        const columnName = columnNameMap[type];

        const { data, error } = await supabaseClient
          .from(table)
          .select(`interaction_description, ${columnName}`)
          .eq('user_id', user_id)
          .single();

        if (error || !data) continue;

        // Write interaction_description to column 0 (if empty) and value to mapped column
        const descCell = rows[row].children[0];
        const valueCell = rows[row].children[column];

        if (!descCell.textContent.trim()) {
          descCell.textContent = data.interaction_description || '';
        }
        valueCell.textContent = data[columnName] || '';
      }

      calculateSubtotals();
    }

    function calculateSubtotals() {
      let cash = 0, debt = 0, gold = 0, crypto = 0;
      document.querySelectorAll('#bankTableBody tr').forEach(row => {
        const cells = row.children;
        cash += parseFloat(cells[1].textContent) || 0;
        debt += parseFloat(cells[2].textContent) || 0;
        gold += parseFloat(cells[3].textContent) || 0;
        crypto += parseFloat(cells[4].textContent) || 0;
      });
      document.getElementById('subtotalCash').textContent = cash.toFixed(2);
      document.getElementById('subtotalDebt').textContent = debt.toFixed(2);
      document.getElementById('subtotalGold').textContent = gold.toFixed(2);
      document.getElementById('subtotalCrypto').textContent = crypto.toFixed(2);
      document.getElementById('bankBalance').textContent = (cash + gold + debt + crypto).toFixed(2);
    }
  </script>
</body>
</html>
