<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f4f6;
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .left {
      flex: 1;
    }
    .left img {
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
    }
    .right {
      flex: 1;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #e5e7eb;
    }
    .footer-buttons {
      display: flex;
      gap: 10px;
    }
    .subtotal-row td {
      font-weight: bold;
      background: #f9fafb;
    }
    .balance-row td {
      font-weight: bold;
      background: #e0f2fe;
      font-size: 1.1em;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="left">
    <img src="/page-104.jpg" alt="Exercise 15 Page 104">
  </div>
  <div class="right">
    <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
    <p>Refer to Exercises 10, 11, 13 and 14 (credibility cash, gold, debt, and cryptocurrency). Credibility cash and gold should be positive numbers, while debt and cryptocurrency should be negative. Subtotals and the Reputation Bank Balance are calculated automatically.</p>

    <div>
      <button onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
      <button onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
      <button onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
      <button onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
    </div>

    <table id="bankTable">
      <thead>
        <tr>
          <th>Name/Description</th>
          <th>Credibility Cash Deposits</th>
          <th>Credibility Debt Withdrawals</th>
          <th>Credibility Gold Deposits</th>
          <th>Credibility Cryptocurrency Withdrawals</th>
        </tr>
      </thead>
      <tbody>
        <!-- 12 blank rows -->
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
        <tr><td></td><td></td><td></td><td></td><td></td></tr>
      </tbody>
      <tfoot>
        <tr class="subtotal-row">
          <td>Subtotals</td>
          <td id="subtotalCash"></td>
          <td id="subtotalDebt"></td>
          <td id="subtotalGold"></td>
          <td id="subtotalCrypto"></td>
        </tr>
        <tr class="balance-row">
          <td colspan="5">Reputation Bank Balance: <span id="bankBalance"></span></td>
        </tr>
      </tfoot>
    </table>

    <div class="footer-buttons">
      <button onclick="location.href='/#page/103'">‚Üê Back One Page</button>
      <button onclick="window.print()">üñ®Ô∏è Print</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    const tableMap = {
      cash: ['exercise10_page82', 'exercise10_page83', 'exercise10_page84', 'cash_deposit'],
      gold: ['exercise11_page87', 'exercise11_page88', 'exercise11_page89', 'gold_deposit'],
      debt: ['exercise13_page94', 'exercise13_page95', 'exercise13_page96', 'debt_withdrawal'],
      crypto: ['exercise14_page99', 'exercise14_page100', 'exercise14_page101', 'crypto_withdrawal']
    };

    async function getUserId() {
      const { data: { session } } = await supabase.auth.getSession();
      return session?.user?.id || null;
    }

    async function insertFromExercise(type) {
      const userId = await getUserId();
      if (!userId) return alert("Not signed in");

      const [t1, t2, t3, valueKey] = tableMap[type];
      const tables = [t1, t2, t3];

      try {
        for (let table of tables) {
          const { data } = await supabase.from(table).select('*').eq('user_id', userId).maybeSingle();
          if (data) {
            const label = data.interaction_description || data.description || '(No description)';
            const value = data[valueKey] || 0;
            await supabase.from('exercise15_page104').upsert(
              { user_id: userId, type, label, value },
              { onConflict: ['user_id', 'type', 'label'] }
            );
          }
        }
        await loadData();
      } catch (error) {
        console.error("Insert error:", error.message);
      }
    }

    async function loadData() {
      const userId = await getUserId();
      if (!userId) return;

      const { data, error } = await supabase.from('exercise15_page104').select('*').eq('user_id', userId);
      if (error) return console.error("Load error:", error.message);

      const tbody = document.querySelector("#bankTable tbody");
      const rows = tbody.querySelectorAll("tr");

      rows.forEach(row => row.querySelectorAll("td").forEach(cell => cell.textContent = ""));

      let subtotals = { cash: 0, debt: 0, gold: 0, crypto: 0 };

      data.forEach((entry, i) => {
        const row = rows[i];
        if (!row) return;
        row.cells[0].textContent = entry.label;
        if (entry.type === 'cash') row.cells[1].textContent = entry.value;
        if (entry.type === 'debt') row.cells[2].textContent = entry.value;
        if (entry.type === 'gold') row.cells[3].textContent = entry.value;
        if (entry.type === 'crypto') row.cells[4].textContent = entry.value;
        subtotals[entry.type] += parseFloat(entry.value) || 0;
      });

      document.getElementById("subtotalCash").textContent = subtotals.cash;
      document.getElementById("subtotalDebt").textContent = subtotals.debt;
      document.getElementById("subtotalGold").textContent = subtotals.gold;
      document.getElementById("subtotalCrypto").textContent = subtotals.crypto;

      const total = subtotals.cash + subtotals.gold + subtotals.debt + subtotals.crypto;
      document.getElementById("bankBalance").textContent = total;
    }

    loadData();
  </script>
</body>
</html>
