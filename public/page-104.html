<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    .left {
      flex: 1;
      padding-right: 2rem;
    }
    .right {
      flex: 2;
    }
    .button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #e2e8f0;
    }
    tfoot td {
      background: #e0f2fe;
      font-weight: bold;
    }
    .footer-buttons {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <img src="/page-104.jpg" alt="Exercise 15 Page 104" style="width: 100%; border: 1px solid #ccc;" />
    </div>
    <div class="right">
      <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
      <p>Refer to Exercises 10, 11, 13 and 14 (credibility cash, gold, debt, and cryptocurrency). Credibility cash and gold should be positive numbers, while debt and cryptocurrency should be negative. Subtotals and the Reputation Bank Balance are calculated automatically.</p>

      <div class="button-bar">
        <button onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
        <button onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
        <button onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
        <button onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name/Description</th>
            <th>Credibility Cash Deposits</th>
            <th>Credibility Debt Withdrawals</th>
            <th>Credibility Gold Deposits</th>
            <th>Credibility Cryptocurrency Withdrawals</th>
          </tr>
        </thead>
        <tbody id="bankTableBody">
          <!-- 12 pre-rendered rows -->
          ${Array.from({ length: 12 }).map(() => `
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td>Subtotals</td>
            <td id="subtotalCash"></td>
            <td id="subtotalDebt"></td>
            <td id="subtotalGold"></td>
            <td id="subtotalCrypto"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align: right;">Reputation Bank Balance: <span id="bankBalance"></span></td>
          </tr>
        </tfoot>
      </table>

      <div class="footer-buttons">
        <button onclick="window.location.href='/#page/103'">‚¨Ö Back One Page</button>
        <button onclick="window.print()">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    const tableMap = {
      cash: ['exercise10_page82', 'exercise10_page83', 'exercise10_page84', 'annual_deposit'],
      gold: ['exercise11_page87', 'exercise11_page88', 'exercise11_page89', 'credibility_gold_deposit'],
      debt: ['exercise13_page94', 'exercise13_page95', 'exercise13_page96', 'annual_deposit'],
      crypto: ['exercise14_page99', 'exercise14_page100', 'exercise14_page101', 'crypto_withdrawal']
    };

    async function insertFromExercise(type) {
      const { data: userData, error: authError } = await supabaseClient.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) return alert("User not logged in");

      const [table1, table2, table3, column] = tableMap[type];
      const tables = [table1, table2, table3];
      let results = [];

      for (let t of tables) {
        const { data, error } = await supabaseClient
          .from(t)
          .select(`interaction_description, ${column}`)
          .eq('user_id', user_id);
        if (!error && data) results = results.concat(data);
      }

      const tbody = document.getElementById('bankTableBody');
      const rows = tbody.querySelectorAll('tr');
      let filled = 0;

      for (let i = 0; i < rows.length && filled < results.length; i++) {
        const row = rows[i];
        const cellDesc = row.children[0];
        const valueCellIndex = { cash: 1, debt: 2, gold: 3, crypto: 4 }[type];

        // Only overwrite empty cells
        if (!row.children[valueCellIndex].textContent.trim()) {
          cellDesc.textContent = results[filled].interaction_description || '';
          row.children[valueCellIndex].textContent = results[filled][column] || '';
          filled++;
        }
      }

      calculateSubtotals();
    }

    function calculateSubtotals() {
      let cash = 0, debt = 0, gold = 0, crypto = 0;
      document.querySelectorAll('#bankTableBody tr').forEach(row => {
        const cells = row.children;
        cash += parseFloat(cells[1].textContent) || 0;
        debt += parseFloat(cells[2].textContent) || 0;
        gold += parseFloat(cells[3].textContent) || 0;
        crypto += parseFloat(cells[4].textContent) || 0;
      });
      document.getElementById('subtotalCash').textContent = cash.toFixed(2);
      document.getElementById('subtotalDebt').textContent = debt.toFixed(2);
      document.getElementById('subtotalGold').textContent = gold.toFixed(2);
      document.getElementById('subtotalCrypto').textContent = crypto.toFixed(2);
      document.getElementById('bankBalance').textContent = (cash + gold + debt + crypto).toFixed(2);
    }

    // Add 12 blank rows on page load (ensures it works even if innerHTML fails)
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById('bankTableBody');
      if (tbody.children.length < 12) {
        for (let i = tbody.children.length; i < 12; i++) {
          const row = document.createElement('tr');
          for (let j = 0; j < 5; j++) {
            const td = document.createElement('td');
            td.contentEditable = true;
            row.appendChild(td);
          }
          tbody.appendChild(row);
        }
      }
    });
  </script>
</body>
</html>
