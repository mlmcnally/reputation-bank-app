<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise 15 ‚Äì Page 104</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    .left {
      flex: 1;
      margin-right: 2rem;
    }
    .left img {
      width: 100%;
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
    }
    .right {
      flex: 2;
    }
    .instructions {
      margin-bottom: 1rem;
    }
    .button-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #e2e8f0;
    }
    tfoot td {
      background: #e0f2fe;
      font-weight: bold;
    }
    .footer-buttons {
      margin-top: 2rem;
      display: flex;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <img src="/page-104.jpg" alt="Exercise 15 Page 104" />
      <div class="button-bar">
        <button onclick="insertFromExercise('cash')">Insert Credibility Cash Deposits</button>
        <button onclick="insertFromExercise('gold')">Insert Credibility Gold Deposits</button>
        <button onclick="insertFromExercise('debt')">Insert Credibility Debt Withdrawals</button>
        <button onclick="insertFromExercise('crypto')">Insert Credibility Cryptocurrency Withdrawals</button>
      </div>
    </div>
    <div class="right">
      <h2>Exercise 15 ‚Äì Reputation Bank Statement</h2>
      <p class="instructions">
        This exercise is your opportunity to see the whole picture of your reputation bank ‚Äì both the deposits and withdrawals. Use the buttons below to add your deposits and then your withdrawals. Take this opportunity to consider if there is more you can do to keep your reputation in the black and sustainably healthy. Return to Exercises 10‚Äì14 to reconsider ways to increase the quantity of credibility cash deposits, expand the scope of credibility gold deposits and mitigate the impacts of withdrawals or eliminate the risks entirely. Then come back to this balance sheet to see the effects on your reputation's bottom line.
      </p>
      <table>
        <thead>
          <tr>
            <th>Name/Description</th>
            <th>Credibility Cash Deposits</th>
            <th>Credibility Debt Withdrawals</th>
            <th>Credibility Gold Deposits</th>
            <th>Credibility Cryptocurrency Withdrawals</th>
          </tr>
        </thead>
        <tbody id="bankTableBody"></tbody>
        <tfoot>
          <tr>
            <td>Subtotals</td>
            <td id="subtotalCash"></td>
            <td id="subtotalDebt"></td>
            <td id="subtotalGold"></td>
            <td id="subtotalCrypto"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align: right;">Reputation Bank Balance: <span id="bankBalance"></span></td>
          </tr>
        </tfoot>
      </table>

      <div class="footer-buttons">
  <button onclick="window.location.href='/#page/103'">‚¨Ö Go Back One Page</button>
  <button onclick="saveData()">üíæ Save</button>
  <button onclick="saveAndNext()">‚û° Save & Go to Page 105</button>
  <button onclick="window.print()">üñ®Ô∏è Print</button>
</div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://nidxvthbowdgdfuopmzk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pZHh2dGhib3dkZ2RmdW9wbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNTYwMjgsImV4cCI6MjA1OTczMjAyOH0.EaRbqF0WYFzYfjL5A6ykQKzHCZzCNPWJINIVwosqYk4'
    );

    // Create 12 editable rows
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById('bankTableBody');
      for (let i = 0; i < 12; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 5; j++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
    });

    const rowMap = {
      cash: [
        { row: 0, table: 'exercise10_page82' },
        { row: 1, table: 'exercise10_page83' },
        { row: 2, table: 'exercise10_page84' }
      ],
      gold: [
        { row: 3, table: 'exercise11_page87' },
        { row: 4, table: 'exercise11_page88' },
        { row: 5, table: 'exercise11_page89' }
      ],
      debt: [
        { row: 6, table: 'exercise13_page94' },
        { row: 7, table: 'exercise13_page95' },
        { row: 8, table: 'exercise13_page96' }
      ],
      crypto: [
        { row: 9, table: 'exercise14_page99' },
        { row: 10, table: 'exercise14_page100' },
        { row: 11, table: 'exercise14_page101' }
      ]
    };

    const columnMap = {
      cash: 'annual_deposit',
      gold: 'credibility_gold_deposit',
      debt: 'annual_deposit',
      crypto: 'crypto_withdrawal'
    };
    async function insertFromExercise(type) {
      const { data: userData, error: authError } = await supabaseClient.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) return alert("User not logged in");

      const rows = document.querySelectorAll('#bankTableBody tr');
      const targets = rowMap[type];
      const column = columnMap[type];

      for (const target of targets) {
        const { data, error } = await supabaseClient
          .from(target.table)
          .select(`interaction_description, ${column}`)
          .eq('user_id', user_id)
          .maybeSingle();

        if (!error && data) {
          rows[target.row].children[0].textContent = data.interaction_description || '';
          const colIndex = { cash: 1, debt: 2, gold: 3, crypto: 4 }[type];
          rows[target.row].children[colIndex].textContent = data[column] ?? '';
        }
      }

      calculateSubtotals();
    }

    function calculateSubtotals() {
      let cash = 0, debt = 0, gold = 0, crypto = 0;
      document.querySelectorAll('#bankTableBody tr').forEach(row => {
        const cells = row.children;
        cash += parseFloat(cells[1].textContent) || 0;
        debt += parseFloat(cells[2].textContent) || 0;
        gold += parseFloat(cells[3].textContent) || 0;
        crypto += parseFloat(cells[4].textContent) || 0;
      });
      document.getElementById('subtotalCash').textContent = cash.toFixed(2);
      document.getElementById('subtotalDebt').textContent = debt.toFixed(2);
      document.getElementById('subtotalGold').textContent = gold.toFixed(2);
      document.getElementById('subtotalCrypto').textContent = crypto.toFixed(2);
      document.getElementById('bankBalance').textContent = (cash + gold + debt + crypto).toFixed(2);
    }

    async function saveData() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) return alert("User not logged in");

      const updates = [];
      const rows = document.querySelectorAll('#bankTableBody tr');

      rows.forEach((row, i) => {
        const cells = row.children;
        updates.push({
          user_id,
          row_number: i + 1,
          interaction_description: cells[0].textContent.trim(),
          credibility_cash_deposit: parseFloat(cells[1].textContent) || 0,
          credibility_debt_withdrawal: parseFloat(cells[2].textContent) || 0,
          credibility_gold_deposit: parseFloat(cells[3].textContent) || 0,
          credibility_crypto_withdrawal: parseFloat(cells[4].textContent) || 0
        });
      });

      for (const row of updates) {
        await supabaseClient
          .from('exercise15_page104')
          .upsert(row, { onConflict: ['user_id', 'row_number'] });
      }

      alert("Save successful!");
    }

    async function saveAndNext() {
      await saveData();
      window.location.href = "/#page/105";
    }
  </script>
</body>
</html>
